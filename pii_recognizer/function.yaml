kind: job
metadata:
  name: pii-recognizer
  tag: ''
  hash: 0972dbbfd83e86970a3655774ace0c074ea617ce
  project: llm-workflow-gilads
  labels:
    author: pgw
  categories:
  - machine-learning
  - data-preparation
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCmltcG9ydCBsb2dnaW5nCmltcG9ydCBvcwppbXBvcnQgcGF0aGxpYgppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHdhcm5pbmdzCmZyb20gY29sbGVjdGlvbnMuYWJjIGltcG9ydCBJdGVyYWJsZQpmcm9tIHR5cGluZyBpbXBvcnQgQW55LCBEaWN0LCBMaXN0LCBPcHRpb25hbCwgU2V0LCBUdXBsZSwgVW5pb24KCmltcG9ydCBhbm5vdGF0ZWRfdGV4dC51dGlsIGFzIGF0X3V0aWwKaW1wb3J0IG1scnVuCmltcG9ydCBubHRrCmltcG9ydCBwcmVzaWRpb19hbmFseXplciBhcyBwYQppbXBvcnQgcHJlc2lkaW9fYW5vbnltaXplciBhcyBwcmVfYW5veW1pemVyCmZyb20gcHJlc2lkaW9fYW5vbnltaXplci5lbnRpdGllcyBpbXBvcnQgT3BlcmF0b3JDb25maWcKZnJvbSB0cWRtLmF1dG8gaW1wb3J0IHRxZG0KCnRyeToKICAgIGltcG9ydCBmbGFpciBhcyBmbApleGNlcHQgTW9kdWxlTm90Rm91bmRFcnJvcjoKICAgIHByaW50KCJGbGFpciBpcyBub3QgaW5zdGFsbGVkIikKCiMgVGhlcmUgaXMgYSBjb25mbGljdCBiZXR3ZWVuIFJ1c3QtYmFzZWQgdG9rZW5pemVycycgcGFyYWxsZWwgcHJvY2Vzc2luZwojIGFuZCBQeXRob24ncyBmb3JrIG9wZXJhdGlvbnMgZHVyaW5nIG11bHRpcHJvY2Vzc2luZy4gVG8gYXZvaWQgdGhpcywgd2UgbmVlZAojIHRoZSBmb2xsb3dpbmcgdHdvIGxpbmVzCgpvcy5lbnZpcm9uWyJUT0tFTklaRVJTX1BBUkFMTEVMSVNNIl0gPSAiZmFsc2UiCndhcm5pbmdzLmZpbHRlcndhcm5pbmdzKCJpZ25vcmUiKQoKbG9nZ2VyID0gbG9nZ2luZy5nZXRMb2dnZXIoInBpaS1yZWNvZ25pemVyIikKCgojIEFkZCB0aGUgY29uc3RhbnQgY2xhc3NlcyBvZiBNb2RlbHMgYW5kIEVudGl0aWVzIHRvIGdvdmVybiB0aGUgd2hvbGUgcGFja2FnZQpjbGFzcyBNb2RlbHM6CiAgICBXSE9MRSA9ICJ3aG9sZSIKICAgIFBBVFRFUk4gPSAicGF0dGVybiIKICAgIFNQQUNZID0gInNwYWN5IgogICAgRkxBSVIgPSAiZmxhaXIiCgoKY2xhc3MgRW50aXRpZXM6CiAgICBDUkVESVRfQ0FSRCA9ICJDUkVESVRfQ0FSRCIKICAgIFNTTiA9ICJTU04iCiAgICBQSE9ORSA9ICJQSE9ORSIKICAgIEVNQUlMID0gIkVNQUlMIgogICAgTE9DQVRJT04gPSAiTE9DQVRJT04iCiAgICBQRVJTT04gPSAiUEVSU09OIgogICAgTlJQID0gIk5SUCIKICAgIE9SR0FOSVpBVElPTiA9ICJPUkdBTklaQVRJT04iCiAgICBEQVRFX1RJTUUgPSAiREFURV9USU1FIgogICAgR1BFID0gKCJHUEUiLCkKICAgIE1BQ19BRERSRVNTID0gIk1BQ19BRERSRVNTIgogICAgVVNfQkFOS19OVU1CRVIgPSAiVVNfQkFOS19OVU1CRVIiCiAgICBJTUVJID0gIklNRUkiCiAgICBUSVRMRSA9ICJUSVRMRSIKICAgIExJQ0VOU0VfUExBVEUgPSAiTElDRU5TRV9QTEFURSIKICAgIFVTX1BBU1NQT1JUID0gIlVTX1BBU1NQT1JUIgogICAgQ1VSUkVOQ1kgPSAiQ1VSUkVOQ1kiCiAgICBST1VUSU5HX05VTUJFUiA9ICJST1VUSU5HX05VTUJFUiIKICAgIFVTX0lUSU4gPSAiVVNfSVRJTiIKICAgIFVTX0JBTktfTlVNQkVSID0gIlVTX0JBTktfTlVNQkVSIgogICAgVVNfRFJJVkVSX0xJQ0VOU0UgPSAiVVNfRFJJVkVSX0xJQ0VOU0UiCiAgICBBR0UgPSAiQUdFIgogICAgUEFTU1dPUkQgPSAiUEFTU1dPUkQiCiAgICBTV0lGVF9DT0RFID0gIlNXSUZUX0NPREUiCgoKY2xhc3MgUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5OgogICAgIiIiCiAgICBGYWN0b3J5IGZvciBjcmVhdGluZyBwYXR0ZXJuIHJlY29nbml6ZXJzLCBpdCBjYW4gYmUgZXh0ZW5kZWQgaW4gdGhlIGZ1dHVyZSB0bwogICAgYWRkIG1vcmUgcmVnZXggcGF0dGVybiBmb3IgZGlmZmVyZW50IGVudGl0aWVzLiBGb3IgdGhlIHBhdHRlcm4gcmVjb2duaXplciB0byB3b3JrLAogICAgd2UgbmVlZCBjb25zdHJ1Y3QgYSBsaXN0IG9mIHJlZ2V4IHBhdHRlcm5zIGZvciBlYWNoIGVudGl0eS4KICAgICIiIgoKICAgIFJFQ09HTklaQUJMRV9FTlRJVElFUyA9IHsKICAgICAgICAiQ1JFRElUX0NBUkQiOiBbcGEuUGF0dGVybigiQ1JFRElUX0NBUkQiLCByIlxiKD86XGRbIC1dKj8pezEzLDE2fVxiIiwgMC41KV0sCiAgICAgICAgIlNTTiI6IFtwYS5QYXR0ZXJuKCJTU04iLCByIlxiXGR7M30tP1xkezJ9LT9cZHs0fVxiIiwgMC41KV0sCiAgICAgICAgIlBIT05FIjogW3BhLlBhdHRlcm4oIlBIT05FIiwgciJcKD9cZHszfVwpP1stLlxzXT9cZHszfVstLlxzXT9cZHs0fSIsIDAuNSldLAogICAgICAgICJFTUFJTCI6IFtwYS5QYXR0ZXJuKCJFTUFJTCIsIHIiXFMrQFxTKyIsIDAuNSldLAogICAgfQoKICAgICMgY3JlYXRlIGEgbGlzdCBvZiBwYXR0ZXJuIHJlY29nbml6ZXJzCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBfY3JlYXRlX3BhdHRlcm5fcmVjb2duaXplcihjbHMpOgogICAgICAgICIiIgogICAgICAgIEZvciBlYWNoIGVudGl0eSwgY3JlYXRlIGEgbGlzdCBvZiBwYXR0ZXJucyB0byByZWNvZ25pemUgaXQKCiAgICAgICAgOnBhcmFtIGNsczogUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5IGNsYXNzCgogICAgICAgIDpyZXR1cm5zOiBMaXN0IG9mIHBhdHRlcm4gcmVjb2duaXplcnMKICAgICAgICAiIiIKCiAgICAgICAgIyBFbnRpdGllcyB0byByZWNvZ25pemUgYW5kIHRoZWlyIHJlZ2V4IHBhdHRlcm5zCgogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIHBhLlBhdHRlcm5SZWNvZ25pemVyKHN1cHBvcnRlZF9lbnRpdHk9ZW50aXR5LCBwYXR0ZXJucz1wYXR0ZXJuKQogICAgICAgICAgICBmb3IgZW50aXR5LCBwYXR0ZXJuIGluIGNscy5SRUNPR05JWkFCTEVfRU5USVRJRVMuaXRlbXMoKQogICAgICAgIF0KCgpjbGFzcyBDdXN0b21TcGFjeVJlY29nbml6ZXIocGEuTG9jYWxSZWNvZ25pemVyKToKICAgICIiIgogICAgQ3VzdG9tIFNwYWN5IFJlY29nbml6ZXIgZnJvbSBQcmVzaWRpbyBBbmFseXplciB0cmFpbmVkIG9uIFByaXZ5IGRhdGEuCiAgICBUaGUgcHJpdnkgZGF0YSBpcyBnZW5lcmF0ZWQgdXNpbmcgdGhpcyBodHRwczovL2dpdGh1Yi5jb20vcGl4aWUtaW8vcGl4aWUvdHJlZS9tYWluL3NyYy9kYXRhZ2VuL3BpaS9wcml2eQogICAgSXQgY2FuIGJlIHVzZWQgdG8gcmVjb2duaXplIGN1c3RvbSBlbnRpdGllcywgU2luY2Ugd2Ugd2FudCB0byB1c2UgUHJlc2lkaW8ncyBSZWdpc3RyaWVzIHRvIGdlbmVyYXRlIEFuYWx5emVyRW5naW5lLAogICAgaXQgaW5oZXJpdHMgZnJvbSBQcmVzaWRpbyBBbmFseXplcidzIExvY2FsUmVjb2duaXplciBjbGFzcy4KICAgICIiIgoKICAgICMgRW50aXRpZXMgdG8gcmVjb2duaXplCgogICAgUkVDT0dOSVpBQkxFX0VOVElUSUVTID0gewogICAgICAgICJMT0NBVElPTiIsCiAgICAgICAgIlBFUlNPTiIsCiAgICAgICAgIk5SUCIsCiAgICAgICAgIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIkRBVEVfVElNRSIsCiAgICB9CgogICAgIyBEZWZhdWx0IGV4cGxhbmF0aW9uIGZvciB0aGlzIHJlY29nbml6ZXIKCiAgICBfREVGQVVMVF9FWFBMQU5BVElPTiA9ICgKICAgICAgICAiSWRlbnRpZmllZCBhcyB7fSBieSBTcGFjeSdzIE5hbWVkIEVudGl0eSBSZWNvZ25pdGlvbiAoUHJpdnktdHJhaW5lZCkiCiAgICApCgogICAgIyBMYWJlbCBncm91cHMgdG8gY2hlY2sKCiAgICBfREVGQVVMVF9DSEVDS19MQUJFTF9HUk9VUFMgPSBbCiAgICAgICAgKHsiTE9DQVRJT04ifSwgeyJMT0MiLCAiTE9DQVRJT04iLCAiU1RSRUVUX0FERFJFU1MiLCAiQ09PUkRJTkFURSJ9KSwKICAgICAgICAoeyJQRVJTT04ifSwgeyJQRVIiLCAiUEVSU09OIn0pLAogICAgICAgICh7Ik5SUCJ9LCB7Ik5PUlAiLCAiTlJQIn0pLAogICAgICAgICh7Ik9SR0FOSVpBVElPTiJ9LCB7Ik9SRyJ9KSwKICAgICAgICAoeyJEQVRFX1RJTUUifSwgeyJEQVRFX1RJTUUifSksCiAgICBdCgogICAgIyBwcmV0cmFpbmVkIG1vZGVsIGZvciB0aGlzIHJlY29nbml6ZXIKCiAgICBfREVGQVVMVF9NT0RFTF9MQU5HVUFHRVMgPSB7CiAgICAgICAgImVuIjogImJla2kvZW5fc3BhY3lfcGlpX2Rpc3RpbGJlcnQiLAogICAgfQoKICAgIF9ERUZBVUxUX1BSRVNJRElPX0VRVUlWQUxFTkNFUyA9IHsKICAgICAgICAiUEVSIjogIlBFUlNPTiIsCiAgICAgICAgIkxPQyI6ICJMT0NBVElPTiIsCiAgICAgICAgIk9SRyI6ICJPUkdBTklaQVRJT04iLAogICAgICAgICJOUk9QIjogIk5SUCIsCiAgICAgICAgIkRBVEVfVElNRSI6ICJEQVRFX1RJTUUiLAogICAgfQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZTogc3RyID0gImVuIiwKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICAgICAgY2hlY2tfbGFiZWxfZ3JvdXBzOiBUdXBsZVtTZXQsIFNldF0gPSBOb25lLAogICAgICAgIGNvbnRleHQ6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICAgICAgbmVyX3N0cmVuZ3RoOiBmbG9hdCA9IDEsCiAgICApOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgU3BhY3kgUmVjb2duaXplci4KCiAgICAgICAgOnBhcmFtIHN1cHBvcnRlZF9sYW5ndWFnZTogTGFuZ3VhZ2UgdG8gdXNlLCBkZWZhdWx0IGlzIEVuZ2xpc2gKICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2VudGl0aWVzOiBFbnRpdGllcyB0byB1c2UgZm9yIHJlY29nbml0aW9uCiAgICAgICAgOnBhcmFtIGNoZWNrX2xhYmVsX2dyb3VwczogTGFiZWwgZ3JvdXBzIHRvIGNoZWNrIGZvciB0aGUgZW50aXRpZXMKICAgICAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICBDb250ZXh0IHRvIHVzZSBpZiBhbnkKICAgICAgICA6cGFyYW0gbmVyX3N0cmVuZ3RoOiAgICAgICBEZWZhdWx0IGNvbmZpZGVuY2UgZm9yIE5FUiBwcmVkaWN0aW9uCgogICAgICAgIDpyZXR1cm5zOiBTcGFjeVJlY29nbml6ZXIgb2JqZWN0CiAgICAgICAgIiIiCgogICAgICAgICMgRGVmYXVsdCBjb25maWRlbmNlIGZvciBORVIgcHJlZGljdGlvbgogICAgICAgIHNlbGYubmVyX3N0cmVuZ3RoID0gbmVyX3N0cmVuZ3RoCgogICAgICAgIHNlbGYuY2hlY2tfbGFiZWxfZ3JvdXBzID0gY2hlY2tfbGFiZWxfZ3JvdXBzIG9yIHNlbGYuX0RFRkFVTFRfQ0hFQ0tfTEFCRUxfR1JPVVBTCiAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzID0gc3VwcG9ydGVkX2VudGl0aWVzIG9yIHNlbGYuUkVDT0dOSVpBQkxFX0VOVElUSUVTCiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygKICAgICAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzPXN1cHBvcnRlZF9lbnRpdGllcywKICAgICAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlPXN1cHBvcnRlZF9sYW5ndWFnZSwKICAgICAgICApCgogICAgIyBnZXQgdGhlIHByZXNpZGlvIGV4cGxhbmF0aW9uIGZvciB0aGUgcmVzdWx0CgogICAgZGVmIF9idWlsZF9zcGFjeV9leHBsYW5hdGlvbigKICAgICAgICBzZWxmLCBvcmlnaW5hbF9zY29yZTogZmxvYXQsIGV4cGxhbmF0aW9uOiBzdHIKICAgICkgLT4gcGEuQW5hbHlzaXNFeHBsYW5hdGlvbjoKICAgICAgICAiIiIKICAgICAgICBDcmVhdGUgZXhwbGFuYXRpb24gZm9yIHdoeSB0aGlzIHJlc3VsdCB3YXMgZGV0ZWN0ZWQuCgogICAgICAgIDpwYXJhbSBvcmlnaW5hbF9zY29yZTogU2NvcmUgZ2l2ZW4gYnkgdGhpcyByZWNvZ25pemVyCiAgICAgICAgOnBhcmFtIGV4cGxhbmF0aW9uOiAgICBFeHBsYW5hdGlvbiBzdHJpbmcKCiAgICAgICAgOnJldHVybnM6IFByZXNpZGlvIEFuYWx5c2lzRXhwbGFuYXRpb24gb2JqZWN0CiAgICAgICAgIiIiCiAgICAgICAgZXhwbGFuYXRpb24gPSBwYS5BbmFseXNpc0V4cGxhbmF0aW9uKAogICAgICAgICAgICByZWNvZ25pemVyPXNlbGYuX19jbGFzc19fLl9fbmFtZV9fLAogICAgICAgICAgICBvcmlnaW5hbF9zY29yZT1vcmlnaW5hbF9zY29yZSwKICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbj1leHBsYW5hdGlvbiwKICAgICAgICApCiAgICAgICAgcmV0dXJuIGV4cGxhbmF0aW9uCgogICAgIyBtYWluIG1ldGhvZCBmb3IgdGhlIHJlY29nbml6ZXIKICAgIGRlZiBhbmFseXplKHNlbGYsIHRleHQ6IHN0ciwgZW50aXRpZXM6IExpc3Rbc3RyXSwgbmxwX2FydGlmYWN0cz1Ob25lKTogICMgbm9xYSBEMTAyCiAgICAgICAgIiIiCiAgICAgICAgQW5hbHl6ZSB0ZXh0IHVzaW5nIFNwYWN5LgoKICAgICAgICA6cGFyYW0gdGV4dDogICAgICAgICAgVGV4dCB0byBhbmFseXplCiAgICAgICAgOnBhcmFtIGVudGl0aWVzOiAgICAgIEVudGl0aWVzIHRvIGFuYWx5emUKICAgICAgICA6cGFyYW0gbmxwX2FydGlmYWN0czogTkxQIGFydGlmYWN0cyB0byB1c2UKCiAgICAgICAgOnJldHVybnM6IExpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBvYmplY3RzCiAgICAgICAgIiIiCiAgICAgICAgcmVzdWx0cyA9IFtdCiAgICAgICAgaWYgbm90IG5scF9hcnRpZmFjdHM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJTa2lwcGluZyBTcGFDeSwgbmxwIGFydGlmYWN0cyBub3QgcHJvdmlkZWQuLi4iKQogICAgICAgICAgICByZXR1cm4gcmVzdWx0cwoKICAgICAgICBuZXJfZW50aXRpZXMgPSBubHBfYXJ0aWZhY3RzLmVudGl0aWVzCgogICAgICAgICMgcmVjb2duaXplIHRoZSBzdXBwb3J0ZWQgZW50aXRpZXMKICAgICAgICBmb3IgZW50aXR5IGluIGVudGl0aWVzOgogICAgICAgICAgICBpZiBlbnRpdHkgbm90IGluIHNlbGYuc3VwcG9ydGVkX2VudGl0aWVzOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgZm9yIGVudCBpbiBuZXJfZW50aXRpZXM6CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fX2NoZWNrX2xhYmVsKGVudGl0eSwgZW50LmxhYmVsXywgc2VsZi5jaGVja19sYWJlbF9ncm91cHMpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgIyBzdHJpbmcgb2YgdGhlIGV4cGxhbmF0aW9uIHNheWluZyB0aGUgZW50aXR5IGlzIHJlY29nbml6ZWQgYnkgc3BhY3kKICAgICAgICAgICAgICAgIHRleHR1YWxfZXhwbGFuYXRpb24gPSBzZWxmLl9ERUZBVUxUX0VYUExBTkFUSU9OLmZvcm1hdChlbnQubGFiZWxfKQogICAgICAgICAgICAgICAgZXhwbGFuYXRpb24gPSBzZWxmLl9idWlsZF9zcGFjeV9leHBsYW5hdGlvbigKICAgICAgICAgICAgICAgICAgICBzZWxmLm5lcl9zdHJlbmd0aCwgdGV4dHVhbF9leHBsYW5hdGlvbgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgICMgY3JlYXRlIHRoZSBzdGFuZGFyZCByZXN1bHQgd2l0aCB0aGUgZW50aXR5LCBzdGFydCwgZW5kLCBzY29yZSwgYW5kIGV4cGxhbmF0aW9uCiAgICAgICAgICAgICAgICBzcGFjeV9yZXN1bHQgPSBwYS5SZWNvZ25pemVyUmVzdWx0KAogICAgICAgICAgICAgICAgICAgIGVudGl0eV90eXBlPWVudGl0eSwKICAgICAgICAgICAgICAgICAgICBzdGFydD1lbnQuc3RhcnRfY2hhciwKICAgICAgICAgICAgICAgICAgICBlbmQ9ZW50LmVuZF9jaGFyLAogICAgICAgICAgICAgICAgICAgIHNjb3JlPXNlbGYubmVyX3N0cmVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGFuYWx5c2lzX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICAgICAgICAgICAgIHJlY29nbml0aW9uX21ldGFkYXRhPXsKICAgICAgICAgICAgICAgICAgICAgICAgcGEuUmVjb2duaXplclJlc3VsdC5SRUNPR05JWkVSX05BTUVfS0VZOiBzZWxmLm5hbWUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoc3BhY3lfcmVzdWx0KQoKICAgICAgICByZXR1cm4gcmVzdWx0cwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfX2NoZWNrX2xhYmVsKAogICAgICAgIGVudGl0eTogc3RyLCBsYWJlbDogc3RyLCBjaGVja19sYWJlbF9ncm91cHM6IFR1cGxlW1NldCwgU2V0XQogICAgKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIENoZWNrIGlmIHRoZSBsYWJlbCBpcyBpbiB0aGUgbGFiZWwgZ3JvdXAuCgogICAgICAgIDpwYXJhbSBlbnRpdHk6ICAgICAgICAgICAgIEVudGl0eSB0byBjaGVjawogICAgICAgIDpwYXJhbSBsYWJlbDogICAgICAgICAgICAgIExhYmVsIHRvIGNoZWNrCiAgICAgICAgOnBhcmFtIGNoZWNrX2xhYmVsX2dyb3VwczogTGFiZWwgZ3JvdXBzIHRvIGNoZWNrCgogICAgICAgIDpyZXR1cm5zOiBUcnVlIGlmIHRoZSBsYWJlbCBpcyBpbiB0aGUgbGFiZWwgZ3JvdXAsIEZhbHNlIG90aGVyd2lzZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBhbnkoCiAgICAgICAgICAgIGVudGl0eSBpbiBlZ3JwIGFuZCBsYWJlbCBpbiBsZ3JwIGZvciBlZ3JwLCBsZ3JwIGluIGNoZWNrX2xhYmVsX2dyb3VwcwogICAgICAgICkKCgojIENsYXNzIHRvIHVzZSBGbGFpciB3aXRoIFByZXNpZGlvIGFzIGFuIGV4dGVybmFsIHJlY29nbml6ZXIuCmNsYXNzIEZsYWlyUmVjb2duaXplcihwYS5FbnRpdHlSZWNvZ25pemVyKToKICAgICIiIgogICAgV3JhcHBlciBmb3IgYSBmbGFpciBtb2RlbCwgaWYgbmVlZGVkIHRvIGJlIHVzZWQgd2l0aGluIFByZXNpZGlvIEFuYWx5emVyLgogICAgVGhpcyBpcyB0byBtYWtlIHN1cmUgdGhlIHJlY29nbml6ZXIgY2FuIGJlIHJlZ2lzdGVyZWQgd2l0aCBQcmVzaWRpbyByZWdpc3RyeS4KICAgICIiIgoKICAgIFJFQ09HTklaQUJMRV9FTlRJVElFUyA9IHsKICAgICAgICAiTE9DQVRJT04iLAogICAgICAgICJQRVJTT04iLAogICAgICAgICJOUlAiLAogICAgICAgICJHUEUiLAogICAgICAgICJPUkdBTklaQVRJT04iLAogICAgICAgICJNQUNfQUREUkVTUyIsCiAgICAgICAgIlVTX0JBTktfTlVNQkVSIiwKICAgICAgICAiSU1FSSIsCiAgICAgICAgIlRJVExFIiwKICAgICAgICAiTElDRU5TRV9QTEFURSIsCiAgICAgICAgIlVTX1BBU1NQT1JUIiwKICAgICAgICAiQ1VSUkVOQ1kiLAogICAgICAgICJST1VUSU5HX05VTUJFUiIsCiAgICAgICAgIlVTX0lUSU4iLAogICAgICAgICJVU19CQU5LX05VTUJFUiIsCiAgICAgICAgIlVTX0RSSVZFUl9MSUNFTlNFIiwKICAgICAgICAiQUdFIiwKICAgICAgICAiUEFTU1dPUkQiLAogICAgICAgICJTV0lGVF9DT0RFIiwKICAgIH0KCiAgICAjIFRoaXMgaXMgdXNlZCB0byBjb25zdHJ1Y3QgdGhlIGV4cGxhbmF0aW9uIGZvciB0aGUgcmVzdWx0CgogICAgX0RFRkFVTFRfRVhQTEFOQVRJT04gPSAiSWRlbnRpZmllZCBhcyB7fSBieSBGbGFpcidzIE5hbWVkIEVudGl0eSBSZWNvZ25pdGlvbiIKCiAgICBfREVGQVVMVF9DSEVDS19MQUJFTF9HUk9VUFMgPSBbCiAgICAgICAgKHsiTE9DQVRJT04ifSwgeyJMT0MiLCAiTE9DQVRJT04iLCAiU1RSRUVUX0FERFJFU1MiLCAiQ09PUkRJTkFURSJ9KSwKICAgICAgICAoeyJQRVJTT04ifSwgeyJQRVIiLCAiUEVSU09OIn0pLAogICAgICAgICh7Ik5SUCJ9LCB7Ik5PUlAiLCAiTlJQIn0pLAogICAgICAgICh7IkdQRSJ9LCB7IkdQRSJ9KSwKICAgICAgICAoeyJPUkdBTklaQVRJT04ifSwgeyJPUkcifSksCiAgICAgICAgKHsiTUFDX0FERFJFU1MifSwgeyJNQUNfQUREUkVTUyJ9KSwKICAgICAgICAoeyJVU19CQU5LX05VTUJFUiJ9LCB7IlVTX0JBTktfTlVNQkVSIn0pLAogICAgICAgICh7IklNRUkifSwgeyJJTUVJIn0pLAogICAgICAgICh7IlRJVExFIn0sIHsiVElUTEUifSksCiAgICAgICAgKHsiTElDRU5TRV9QTEFURSJ9LCB7IkxJQ0VOU0VfUExBVEUifSksCiAgICAgICAgKHsiVVNfUEFTU1BPUlQifSwgeyJVU19QQVNTUE9SVCJ9KSwKICAgICAgICAoeyJDVVJSRU5DWSJ9LCB7IkNVUlJFTkNZIn0pLAogICAgICAgICh7IlJPVVRJTkdfTlVNQkVSIn0sIHsiUk9VVElOR19OVU1CRVIifSksCiAgICAgICAgKHsiQUdFIn0sIHsiQUdFIn0pLAogICAgICAgICh7IkNVUlJFTkNZIn0sIHsiQ1VSUkVOQ1kifSksCiAgICAgICAgKHsiU1dJRlRfQ09ERSJ9LCB7IlNXSUZUX0NPREUifSksCiAgICAgICAgKHsiVVNfSVRJTiJ9LCB7IlVTX0lUSU4ifSksCiAgICAgICAgKHsiVVNfQkFOS19OVU1CRVIifSwgeyJVU19CQU5LX05VTUJFUiJ9KSwKICAgICAgICAoeyJVU19EUklWRVJfTElDRU5TRSJ9LCB7IlVTX0RSSVZFUl9MSUNFTlNFIn0pLAogICAgXQoKICAgIF9ERUZBVUxUX01PREVMX0xBTkdVQUdFUyA9IHsKICAgICAgICAiZW4iOiAiYmVraS9mbGFpci1waWktZGlzdGlsYmVydCIsCiAgICB9CgogICAgX0RFRkFVTFRfUFJFU0lESU9fRVFVSVZBTEVOQ0VTID0gewogICAgICAgICJQRVIiOiAiUEVSU09OIiwKICAgICAgICAiTE9DIjogIkxPQ0FUSU9OIiwKICAgICAgICAiT1JHIjogIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIk5ST1AiOiAiTlJQIiwKICAgICAgICAiVVJMIjogIlVSTCIsCiAgICAgICAgIlVTX0lUSU4iOiAiVVNfSVRJTiIsCiAgICAgICAgIlVTX1BBU1NQT1JUIjogIlVTX1BBU1NQT1JUIiwKICAgICAgICAiSUJBTl9DT0RFIjogIklCQU5fQ09ERSIsCiAgICAgICAgIklQX0FERFJFU1MiOiAiSVBfQUREUkVTUyIsCiAgICAgICAgIkVNQUlMX0FERFJFU1MiOiAiRU1BSUwiLAogICAgICAgICJVU19EUklWRVJfTElDRU5TRSI6ICJVU19EUklWRVJfTElDRU5TRSIsCiAgICAgICAgIlVTX0JBTktfTlVNQkVSIjogIlVTX0JBTktfTlVNQkVSIiwKICAgIH0KCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBzdXBwb3J0ZWRfbGFuZ3VhZ2U6IHN0ciA9ICJlbiIsCiAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzOiBMaXN0W3N0cl0gPSBOb25lLAogICAgICAgIGNoZWNrX2xhYmVsX2dyb3VwczogVHVwbGVbU2V0LCBTZXRdID0gTm9uZSwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgSW5pdGlhbGl6ZSB0aGUgRmxhaXJSZWNvZ25pemVyLgoKICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2xhbmd1YWdlOiBMYW5ndWFnZSB0byB1c2UKICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2VudGl0aWVzOiBFbnRpdGllcyB0byB1c2UKICAgICAgICA6cGFyYW0gY2hlY2tfbGFiZWxfZ3JvdXBzOiBMYWJlbCBncm91cHMgdG8gY2hlY2sKCiAgICAgICAgOnJldHVybnM6IEZsYWlyUmVjb2duaXplciBvYmplY3QKCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5jaGVja19sYWJlbF9ncm91cHMgPSBjaGVja19sYWJlbF9ncm91cHMgb3Igc2VsZi5fREVGQVVMVF9DSEVDS19MQUJFTF9HUk9VUFMKCiAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzID0gc3VwcG9ydGVkX2VudGl0aWVzIG9yIHNlbGYuUkVDT0dOSVpBQkxFX0VOVElUSUVTCiAgICAgICAgc2VsZi5tb2RlbCA9IGZsLm1vZGVscy5TZXF1ZW5jZVRhZ2dlci5sb2FkKAogICAgICAgICAgICBzZWxmLl9ERUZBVUxUX01PREVMX0xBTkdVQUdFUy5nZXQoc3VwcG9ydGVkX2xhbmd1YWdlKQogICAgICAgICkKCiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygKICAgICAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzPXN1cHBvcnRlZF9lbnRpdGllcywKICAgICAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlPXN1cHBvcnRlZF9sYW5ndWFnZSwKICAgICAgICAgICAgbmFtZT0iRmxhaXIgQW5hbHl0aWNzIiwKICAgICAgICApCgogICAgIyBtYWluIG1ldGhvZCBmb3IgdGhlIHJlY29nbml6ZXIKICAgIGRlZiBhbmFseXplKAogICAgICAgIHNlbGYsCiAgICAgICAgdGV4dDogc3RyLAogICAgICAgIGVudGl0aWVzOiBMaXN0W3N0cl0sCiAgICAgICAgbmxwX2FydGlmYWN0czogcGEubmxwX2VuZ2luZS5ObHBBcnRpZmFjdHMgPSBOb25lLAogICAgKSAtPiBMaXN0W3BhLlJlY29nbml6ZXJSZXN1bHRdOgogICAgICAgICIiIgogICAgICAgIEFuYWx5emUgdGV4dCBhbmQgcmV0dXJuIHRoZSByZXN1bHRzLgoKICAgICAgICA6cGFyYW0gdGV4dDogICAgICAgICAgVGhlIHRleHQgZm9yIGFuYWx5c2lzLgogICAgICAgIDpwYXJhbSBlbnRpdGllczogICAgICBUaGUgbGlzdCBvZiBlbnRpdGllcyB0byByZWNvZ25pemUuCiAgICAgICAgOnBhcmFtIG5scF9hcnRpZmFjdHM6IE5vdCB1c2VkIGJ5IHRoaXMgcmVjb2duaXplciBidXQgbmVlZGVkIGZvciB0aGUgaW50ZXJmYWNlLgogICAgICAgIDpwYXJhbSBsYW5ndWFnZTogICAgICBUZXh0IGxhbmd1YWdlLiBTdXBwb3J0ZWQgbGFuZ3VhZ2VzIGluIE1PREVMX0xBTkdVQUdFUwoKICAgICAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIHRoZSByZWNvZ25pemVkIEZsYWlyIGRldGVjdGlvbnMuCiAgICAgICAgIiIiCgogICAgICAgIHJlc3VsdHMgPSBbXQoKICAgICAgICBzZW50ZW5jZXMgPSBmbC5kYXRhLlNlbnRlbmNlKHRleHQpCiAgICAgICAgc2VsZi5tb2RlbC5wcmVkaWN0KHNlbnRlbmNlcykKCiAgICAgICAgIyBJZiB0aGVyZSBhcmUgbm8gc3BlY2lmaWMgbGlzdCBvZiBlbnRpdGllcywgd2Ugd2lsbCBsb29rIGZvciBhbGwgb2YgaXQuCiAgICAgICAgaWYgbm90IGVudGl0aWVzOgogICAgICAgICAgICBlbnRpdGllcyA9IHNlbGYuc3VwcG9ydGVkX2VudGl0aWVzCgogICAgICAgICMgR28gb3ZlciB0aGUgZW50aXRpZXMgYW5kIGNoZWNrIGlmIHRoZXkgYXJlIGluIHRoZSBzdXBwb3J0ZWQgZW50aXRpZXMgbGlzdC4KICAgICAgICBmb3IgZW50aXR5IGluIGVudGl0aWVzOgogICAgICAgICAgICBpZiBlbnRpdHkgbm90IGluIHNlbGYuc3VwcG9ydGVkX2VudGl0aWVzOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgR28gb3ZlciB0aGUgc2VudGVuY2VzIGFuZCBjaGVjayBpZiB0aGUgZW50aXR5IGlzIGluIHRoZSBzZW50ZW5jZS4KICAgICAgICAgICAgZm9yIGVudCBpbiBzZW50ZW5jZXMuZ2V0X3NwYW5zKCJuZXIiKToKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9fY2hlY2tfbGFiZWwoCiAgICAgICAgICAgICAgICAgICAgZW50aXR5LCBlbnQubGFiZWxzWzBdLnZhbHVlLCBzZWxmLmNoZWNrX2xhYmVsX2dyb3VwcwogICAgICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICMgSWYgdGhlIGVudGl0eSBpcyBpbiB0aGUgc2VudGVuY2UsIHdlIHdpbGwgYWRkIGl0IHRvIHRoZSByZXN1bHRzLgogICAgICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbiA9IHNlbGYuX0RFRkFVTFRfRVhQTEFOQVRJT04uZm9ybWF0KAogICAgICAgICAgICAgICAgICAgIGVudC5sYWJlbHNbMF0udmFsdWUKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICAjIEJ1aWxkIHRoZSBleHBsYW5hdGlvbiBmb3IgdGhlIHJlc3VsdAogICAgICAgICAgICAgICAgZXhwbGFuYXRpb24gPSBzZWxmLl9idWlsZF9mbGFpcl9leHBsYW5hdGlvbigKICAgICAgICAgICAgICAgICAgICByb3VuZChlbnQuc2NvcmUsIDIpLCB0ZXh0dWFsX2V4cGxhbmF0aW9uCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgZmxhaXJfcmVzdWx0ID0gc2VsZi5fY29udmVydF90b19yZWNvZ25pemVyX3Jlc3VsdChlbnQsIGV4cGxhbmF0aW9uKQoKICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKGZsYWlyX3Jlc3VsdCkKCiAgICAgICAgcmV0dXJuIHJlc3VsdHMKCiAgICBkZWYgX2NvbnZlcnRfdG9fcmVjb2duaXplcl9yZXN1bHQoCiAgICAgICAgc2VsZiwgZW50aXR5OiBmbC5kYXRhLlNwYW4sIGV4cGxhbmF0aW9uOiBzdHIKICAgICkgLT4gcGEuUmVjb2duaXplclJlc3VsdDoKICAgICAgICAiIiIKICAgICAgICBDb252ZXJ0IEZsYWlyIHJlc3VsdCB0byBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0LgoKICAgICAgICA6cGFyYW0gZW50aXR5OiAgICAgIEZsYWlyIGVudGl0eSBvZiBTcGFuCiAgICAgICAgOnBhcmFtIGV4cGxhbmF0aW9uOiBQcmVzaWRpbyBBbmFseXNpc0V4cGxhbmF0aW9uCgogICAgICAgIDpyZXR1cm5zOiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0CiAgICAgICAgIiIiCgogICAgICAgICMgQ29udmVydCB0aGUgZW50aXR5IHR5cGUgdG8gUHJlc2lkaW8gZW50aXR5IHR5cGUKICAgICAgICBlbnRpdHlfdHlwZSA9IHNlbGYuX0RFRkFVTFRfUFJFU0lESU9fRVFVSVZBTEVOQ0VTLmdldChlbnRpdHkudGFnLCBlbnRpdHkudGFnKQoKICAgICAgICAjIENvbnZlcnQgdGhlIHNjb3JlIHRvIFByZXNpZGlvIHNjb3JlCiAgICAgICAgZmxhaXJfc2NvcmUgPSByb3VuZChlbnRpdHkuc2NvcmUsIDIpCgogICAgICAgICMgQ3JlYXRlIHRoZSBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGZyb20gdGhlIEZsYWlyIGVudGl0eQogICAgICAgIGZsYWlyX3Jlc3VsdHMgPSBwYS5SZWNvZ25pemVyUmVzdWx0KAogICAgICAgICAgICBlbnRpdHlfdHlwZT1lbnRpdHlfdHlwZSwKICAgICAgICAgICAgc3RhcnQ9ZW50aXR5LnN0YXJ0X3Bvc2l0aW9uLAogICAgICAgICAgICBlbmQ9ZW50aXR5LmVuZF9wb3NpdGlvbiwKICAgICAgICAgICAgc2NvcmU9ZmxhaXJfc2NvcmUsCiAgICAgICAgICAgIGFuYWx5c2lzX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICkKCiAgICAgICAgcmV0dXJuIGZsYWlyX3Jlc3VsdHMKCiAgICBkZWYgX2J1aWxkX2ZsYWlyX2V4cGxhbmF0aW9uKAogICAgICAgIHNlbGYsIG9yaWdpbmFsX3Njb3JlOiBmbG9hdCwgZXhwbGFuYXRpb246IHN0cgogICAgKSAtPiBwYS5BbmFseXNpc0V4cGxhbmF0aW9uOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZSBleHBsYW5hdGlvbiBmb3Igd2h5IHRoaXMgcmVzdWx0IHdhcyBkZXRlY3RlZC4KCiAgICAgICAgOnBhcmFtIG9yaWdpbmFsX3Njb3JlOiBTY29yZSBnaXZlbiBieSB0aGlzIHJlY29nbml6ZXIKICAgICAgICA6cGFyYW0gZXhwbGFuYXRpb246ICAgIEV4cGxhbmF0aW9uIHN0cmluZwoKICAgICAgICA6cmV0dXJuczogUHJlc2lkaW8gQW5hbHlzaXNFeHBsYW5hdGlvbgogICAgICAgICIiIgoKICAgICAgICAjIENyZWF0ZSB0aGUgUHJlc2lkaW8gQW5hbHlzaXNFeHBsYW5hdGlvbiBmb3IgdGhlIHJlc3VsdAogICAgICAgIGV4cGxhbmF0aW9uID0gcGEuQW5hbHlzaXNFeHBsYW5hdGlvbigKICAgICAgICAgICAgcmVjb2duaXplcj1zZWxmLl9fY2xhc3NfXy5fX25hbWVfXywKICAgICAgICAgICAgb3JpZ2luYWxfc2NvcmU9b3JpZ2luYWxfc2NvcmUsCiAgICAgICAgICAgIHRleHR1YWxfZXhwbGFuYXRpb249ZXhwbGFuYXRpb24sCiAgICAgICAgKQogICAgICAgIHJldHVybiBleHBsYW5hdGlvbgoKICAgICMgc2FuaXR5IGNoZWNrIG9mIHRoZSBlbnRpdHkgYW5kIGxhYmVsIGJlZm9yZSByZWNvZ25pdGlvbgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9fY2hlY2tfbGFiZWwoCiAgICAgICAgZW50aXR5OiBzdHIsIGxhYmVsOiBzdHIsIGNoZWNrX2xhYmVsX2dyb3VwczogVHVwbGVbU2V0LCBTZXRdCiAgICApIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIGFueSgKICAgICAgICAgICAgZW50aXR5IGluIGVncnAgYW5kIGxhYmVsIGluIGxncnAgZm9yIGVncnAsIGxncnAgaW4gY2hlY2tfbGFiZWxfZ3JvdXBzCiAgICAgICAgKQoKCiMgZ2V0IHRoZSBhbmFseXplciBlbmdpbmUgYmFzZWQgb24gdGhlIG1vZGVsCmRlZiBfZ2V0X2FuYWx5emVyX2VuZ2luZSgKICAgIG1vZGVsOiBzdHIgPSBOb25lLCBlbnRpdGllczogTGlzdFtzdHJdID0gTm9uZQopIC0+IHBhLkFuYWx5emVyRW5naW5lOgogICAgIiIiCiAgICBSZXR1cm4gcGEuQW5hbHl6ZXJFbmdpbmUuCgogICAgOnBhcmFtIG1vZGVsOiBUaGUgbW9kZWwgdG8gdXNlLiBDYW4gYmUgInNwYWN5IiwgImZsYWlyIiwgInBhdHRlcm4iIG9yICJ3aG9sZSIuCiAgICA6cGFyYW0gZW50aXRpZXM6IFRoZSBsaXN0IG9mIGVudGl0aWVzIHRvIHVzZS4KCiAgICA6cmV0dXJuczogcGEuQW5hbHl6ZXJFbmdpbmUKICAgICIiIgogICAgIyByZWNvZ25pemVyIHJlZ2lzdHJ5IHRoYXQgY2FuIHN0b3JlIG11bHRpcGxlIHJlY29nbml6ZXJzCiAgICByZWdpc3RyeSA9IHBhLlJlY29nbml6ZXJSZWdpc3RyeSgpCiAgICBpZiBtb2RlbCA9PSBNb2RlbHMuU1BBQ1k6CiAgICAgICAgIyBjdXN0b20gc3BhY3kgcmVjb2duaXplcgogICAgICAgIHNwYWN5X3JlY29nbml6ZXIgPSBDdXN0b21TcGFjeVJlY29nbml6ZXIoKQogICAgICAgICMgYWRkIHRoZSBjdXN0b20gYnVpbGQgc3BhY3kgcmVjb2duaXplcgogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHNwYWN5X3JlY29nbml6ZXIpCiAgICBlbGlmIG1vZGVsID09IE1vZGVscy5GTEFJUjoKICAgICAgICAjIHByZS10cmFpbmVkIGZsYWlyIHJlY29nbml6ZXIKICAgICAgICBmbGFpcl9yZWNvZ25pemVyID0gRmxhaXJSZWNvZ25pemVyKCkKICAgICAgICAjIGFkZCB0aGUgY3VzdG9tIGJ1aWxkIGZsYWlyIHJlY29nbml6ZXIKICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihmbGFpcl9yZWNvZ25pemVyKQogICAgZWxpZiBtb2RlbCA9PSBNb2RlbHMuUEFUVEVSTjoKICAgICAgICAjIGFkZCB0aGUgcGF0dGVybiByZWNvZ25pemVyCiAgICAgICAgcGF0dGVybl9yZWNvZ25pemVyX2ZhY3RvcnkgPSBQYXR0ZXJuUmVjb2duaXplckZhY3RvcnkoKQogICAgICAgIGZvciByZWNvZ25pemVyIGluIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5Ll9jcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKCk6CiAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHJlY29nbml6ZXIpCiAgICBlbGlmIG1vZGVsID09IE1vZGVscy5XSE9MRToKICAgICAgICBzcGFjeV9yZWNvZ25pemVyID0gQ3VzdG9tU3BhY3lSZWNvZ25pemVyKCkKICAgICAgICBmbGFpcl9yZWNvZ25pemVyID0gRmxhaXJSZWNvZ25pemVyKCkKICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihzcGFjeV9yZWNvZ25pemVyKQogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKGZsYWlyX3JlY29nbml6ZXIpCiAgICAgICAgIyBhZGQgdGhlIHBhdHRlcm4gcmVjb2duaXplcgogICAgICAgIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5ID0gUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5KCkKICAgICAgICBmb3IgcmVjb2duaXplciBpbiBwYXR0ZXJuX3JlY29nbml6ZXJfZmFjdG9yeS5fY3JlYXRlX3BhdHRlcm5fcmVjb2duaXplcigpOgogICAgICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihyZWNvZ25pemVyKQogICAgZWxpZiBub3QgbW9kZWwgYW5kIGVudGl0aWVzOgogICAgICAgIGlmIHNldChlbnRpdGllcykgJiBDdXN0b21TcGFjeVJlY29nbml6ZXIuUkVDT0dOSVpBQkxFX0VOVElUSUVTOgogICAgICAgICAgICBzcGFjeV9yZWNvZ25pemVyID0gQ3VzdG9tU3BhY3lSZWNvZ25pemVyKCkKICAgICAgICAgICAgcmVnaXN0cnkuYWRkX3JlY29nbml6ZXIoc3BhY3lfcmVjb2duaXplcikKICAgICAgICBpZiBzZXQoZW50aXRpZXMpICYgRmxhaXJSZWNvZ25pemVyLlJFQ09HTklaQUJMRV9FTlRJVElFUzoKICAgICAgICAgICAgZmxhaXJfcmVjb2duaXplciA9IEZsYWlyUmVjb2duaXplcigpCiAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKGZsYWlyX3JlY29nbml6ZXIpCiAgICAgICAgIyBhZGQgdGhlIHBhdHRlcm4gcmVjb2duaXplcgogICAgICAgIGlmIHNldChlbnRpdGllcykgJiAoc2V0KFBhdHRlcm5SZWNvZ25pemVyRmFjdG9yeS5SRUNPR05JWkFCTEVfRU5USVRJRVMua2V5cygpKSk6CiAgICAgICAgICAgIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5ID0gUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5KCkKICAgICAgICAgICAgZm9yIHJlY29nbml6ZXIgaW4gcGF0dGVybl9yZWNvZ25pemVyX2ZhY3RvcnkuX2NyZWF0ZV9wYXR0ZXJuX3JlY29nbml6ZXIoKToKICAgICAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHJlY29nbml6ZXIpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiYXJndW1lbnQgb2YgbW9kZWwgYW5kIGVudGl0aWVzIGNhbiBub3QgYmUgTm9uZSBhdCB0aGUgc2FtZSB0aW1lIgogICAgICAgICkKICAgIGFuYWx5emVyID0gcGEuQW5hbHl6ZXJFbmdpbmUoCiAgICAgICAgcmVnaXN0cnk9cmVnaXN0cnksCiAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlcz1bImVuIl0sCiAgICApCgogICAgc3VwcG9ydGVkX2VudGl0aWVzID0gYW5hbHl6ZXIuZ2V0X3N1cHBvcnRlZF9lbnRpdGllcygpCgogICAgaWYgZW50aXRpZXMgYW5kIG5vdCBhbGwoaXRlbSBpbiBzdXBwb3J0ZWRfZW50aXRpZXMgZm9yIGl0ZW0gaW4gZW50aXRpZXMpOgogICAgICAgIG5vdF9zdXBwb3J0ZWRfZW50aXRpZXMgPSBbCiAgICAgICAgICAgIGl0ZW0gZm9yIGl0ZW0gaW4gZW50aXRpZXMgaWYgaXRlbSBub3QgaW4gc3VwcG9ydGVkX2VudGl0aWVzCiAgICAgICAgXQogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiVGhlIGN1cnJlbnQgbW9kZWwge21vZGVsfSBkb2Vzbid0IHN1cHBvcnQgdGhlIGZvbGxvd2luZyBlbnRpdGllczoge25vdF9zdXBwb3J0ZWRfZW50aXRpZXN9LiAiCiAgICAgICAgICAgIGYiU3VwcG9ydGVkIGVudGl0aWVzIGFyZToge3N1cHBvcnRlZF9lbnRpdGllc30iCiAgICAgICAgKQogICAgcmV0dXJuIGFuYWx5emVyCgoKZGVmIF9nZXRfYW5vbnltaXplcl9lbmdpbmUoKSAtPiBwcmVfYW5veW1pemVyLkFub255bWl6ZXJFbmdpbmU6CiAgICAiIiIKICAgIFJldHVybiBBbm9ueW1pemVyRW5naW5lLgoKICAgIDpyZXR1cm5zOiBUaGUgQW5vbnltaXplckVuZ2luZS4KICAgICIiIgogICAgcmV0dXJuIHByZV9hbm95bWl6ZXIuQW5vbnltaXplckVuZ2luZSgpCgoKZGVmIF9hbm9ueW1pemUoCiAgICB0ZXh0OiBzdHIsCiAgICBhbmFseXplX3Jlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sCiAgICBlbnRpdHlfb3BlcmF0b3JfbWFwOiBkaWN0ID0gTm9uZSwKICAgIGlzX2Z1bGxfdGV4dDogYm9vbCA9IFRydWUsCikgLT4gc3RyOgogICAgIiIiCiAgICBBbm9ueW1pemUgaWRlbnRpZmllZCBpbnB1dCB1c2luZyBQcmVzaWRpbyBBYm9ueW1pemVyLgoKICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgICAgICAgICBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gYW5hbHl6ZV9yZXN1bHRzOiAgICAgVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tCiAgICA6cGFyYW0gZW50aXR5X29wZXJhdG9yX21hcDogVGhlIGVudGl0eV9vcGVyYXRvcl9tYXAgaXMgYSBkaWN0aW9uYXJ5IHRoYXQgbWFwcyBlbnRpdHkgdG8gb3BlcmF0b3IgbmFtZSBhbmQgb3BlcmF0b3IgcGFyYW1zLgogICAgOnBhcmFtIGlzX2Z1bGxfdGV4dDogICAgICAgIFdoZXRoZXIgdGhlIHRleHQgaXMgZnVsbCB0ZXh0IG9yIG5vdC4KCiAgICA6cmV0dXJuczogVGhlIGFub255bWl6ZWQgdGV4dC4KICAgICIiIgogICAgaWYgbm90IHRleHQ6CiAgICAgICAgcmV0dXJuICIiCgogICAgYW5vbnltaXplcl9lbmdpbmUgPSBfZ2V0X2Fub255bWl6ZXJfZW5naW5lKCkKICAgIGlmIG5vdCBlbnRpdHlfb3BlcmF0b3JfbWFwOgogICAgICAgIG9wZXJhdG9ycyA9IE5vbmUKICAgIGVsc2U6CiAgICAgICAgIyBDcmVhdGUgT3BlcmF0b3JDb25maWcgYmFzZWQgb24gdGhlIGVudGl0eV9vcGVyYXRvcl9tYXAKICAgICAgICBvcGVyYXRvcnMgPSB7CiAgICAgICAgICAgIGVudGl0eTogT3BlcmF0b3JDb25maWcob3BlcmF0b3JfbmFtZSwgb3BlcmF0b3JfcGFyYW1zKQogICAgICAgICAgICBmb3IgZW50aXR5LCAob3BlcmF0b3JfbmFtZSwgb3BlcmF0b3JfcGFyYW1zKSBpbiBlbnRpdHlfb3BlcmF0b3JfbWFwLml0ZW1zKCkKICAgICAgICB9CgogICAgaWYgaXNfZnVsbF90ZXh0OgogICAgICAgICMgQW5vbnltaXplIHRoZSBlbnRpcmUgdGV4dAogICAgICAgIHJldHVybiBhbm9ueW1pemVyX2VuZ2luZS5hbm9ueW1pemUoCiAgICAgICAgICAgIHRleHQ9dGV4dCwgYW5hbHl6ZXJfcmVzdWx0cz1hbmFseXplX3Jlc3VsdHMsIG9wZXJhdG9ycz1vcGVyYXRvcnMKICAgICAgICApLnRleHQKICAgICMgVG9rZW5pemUgdGhlIHRleHQgdG8gc2VudGVuY2VzCiAgICBzZW50ZW5jZXMgPSBubHRrLnNlbnRfdG9rZW5pemUodGV4dCkKICAgIGFub255bWl6ZWRfc2VudGVuY2VzID0gW10KICAgIGN1cnJlbnRfaWR4ID0gMAoKICAgICMgRmluZCB0aGUgc2VudGVuY2UgdGhhdCBoYXMgcGlpIGVudGl0eQogICAgZm9yIHNlbnRlbmNlIGluIHNlbnRlbmNlczoKICAgICAgICBzdGFydF9pZHggPSBjdXJyZW50X2lkeAogICAgICAgIGVuZF9pZHggPSBzdGFydF9pZHggKyBsZW4oc2VudGVuY2UpCgogICAgICAgICMgR2V0IHRoZSBlbnRpdGllcyB0aGF0IGFyZSBpbiB0aGUgc2VudGVuY2UsIHVwZGF0ZSBodGUgc3RhcnRfaWR4IGFuZCBlbmRfaWR4CiAgICAgICAgc2VudGVuY2VfcmVzdWx0cyA9IFsKICAgICAgICAgICAgcGEuUmVjb2duaXplclJlc3VsdCgKICAgICAgICAgICAgICAgIHJlc3VsdC5lbnRpdHlfdHlwZSwKICAgICAgICAgICAgICAgIHN0YXJ0PXJlc3VsdC5zdGFydCAtIHN0YXJ0X2lkeCwKICAgICAgICAgICAgICAgIGVuZD1yZXN1bHQuZW5kIC0gc3RhcnRfaWR4LAogICAgICAgICAgICAgICAgc2NvcmU9cmVzdWx0LnNjb3JlLAogICAgICAgICAgICApCiAgICAgICAgICAgIGZvciByZXN1bHQgaW4gYW5hbHl6ZV9yZXN1bHRzCiAgICAgICAgICAgIGlmIHJlc3VsdC5zdGFydCA+PSBzdGFydF9pZHggYW5kIHJlc3VsdC5lbmQgPD0gZW5kX2lkeAogICAgICAgIF0KCiAgICAgICAgIyBJZiBQSUkgaXMgZGV0ZWN0ZWQKICAgICAgICBpZiBzZW50ZW5jZV9yZXN1bHRzOgogICAgICAgICAgICBhbm9ueW1pemVkX3NlbnRlbmNlID0gYW5vbnltaXplcl9lbmdpbmUuYW5vbnltaXplKAogICAgICAgICAgICAgICAgdGV4dD1zZW50ZW5jZSwgYW5hbHl6ZXJfcmVzdWx0cz1zZW50ZW5jZV9yZXN1bHRzLCBvcGVyYXRvcnM9b3BlcmF0b3JzCiAgICAgICAgICAgICkudGV4dAogICAgICAgICAgICBhbm9ueW1pemVkX3NlbnRlbmNlcy5hcHBlbmQoYW5vbnltaXplZF9zZW50ZW5jZSkKCiAgICAgICAgY3VycmVudF9pZHggPSBlbmRfaWR4CgogICAgcmV0dXJuICIgIi5qb2luKGFub255bWl6ZWRfc2VudGVuY2VzKQoKCmRlZiBfZ2V0X3Rva2VucygKICAgIHRleHQ6IHN0ciwgYW5hbHl6ZV9yZXN1bHRzOiBMaXN0W3BhLlJlY29nbml6ZXJSZXN1bHRdLCBpc19mdWxsOiBib29sID0gVHJ1ZQopIC0+IExpc3Rbc3RyXToKICAgICIiIgogICAgR2V0IHRoZSBmdWxsIHRva2VucyBvciBvbmx5IGNvbnRhaW5zIHRoZSBlbnRpdGllcyB0aGF0IGNhbiBmb3JtIGEgc2VudGVuY2UuCgogICAgOnBhcmFtIHRleHQ6ICAgICAgICAgICAgVGhlIHRleHQgZm9yIGFuYWx5c2lzLgogICAgOnBhcmFtIGFuYWx5emVfcmVzdWx0czogVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tCiAgICA6cGFyYW0gaXNfZnVsbDogICAgICAgICBXaGV0aGVyIHJldHVybiBmdWxsIHRva2VucyBvciBqdXN0IHRoZSB0b2tlbnMgdGhhdCBvbmx5IGNvbnRhaW5zIHRoZSBlbnRpdGllcyB0aGF0IGNhbiBmb3JtIGEgc2VudGVuY2UuCgogICAgOnJldHVybnM6IFRoZSB0b2tlbnMuCiAgICAiIiIKCiAgICB0b2tlbnMgPSBbXQogICAgIyBzb3J0IGJ5IHN0YXJ0IGluZGV4CiAgICByZXN1bHRzID0gc29ydGVkKGFuYWx5emVfcmVzdWx0cywga2V5PWxhbWJkYSB4OiB4LnN0YXJ0KQogICAgZm9yIGksIHJlcyBpbiBlbnVtZXJhdGUocmVzdWx0cyk6CiAgICAgICAgaWYgaSA9PSAwOgogICAgICAgICAgICB0b2tlbnMuYXBwZW5kKHRleHRbOiByZXMuc3RhcnRdKQoKICAgICAgICAjIGFwcGVuZCBlbnRpdHkgdGV4dCBhbmQgZW50aXR5IHR5cGUKICAgICAgICB0b2tlbnMuYXBwZW5kKCh0ZXh0W3Jlcy5zdGFydCA6IHJlcy5lbmRdLCByZXMuZW50aXR5X3R5cGUpKQoKICAgICAgICAjIGlmIGFub3RoZXIgZW50aXR5IGNvbWluZyBpLmUuIHdlJ3JlIG5vdCBhdCB0aGUgbGFzdCByZXN1bHRzIGVsZW1lbnQsCiAgICAgICAgIyBhZGQgdGV4dCB1cCB0byBuZXh0IGVudGl0eQogICAgICAgIGlmIGkgIT0gbGVuKHJlc3VsdHMpIC0gMToKICAgICAgICAgICAgdG9rZW5zLmFwcGVuZCh0ZXh0W3Jlcy5lbmQgOiByZXN1bHRzW2kgKyAxXS5zdGFydF0pCiAgICAgICAgIyBpZiBubyBtb3JlIGVudGl0aWVzIGNvbWluZywgYWRkIGFsbCByZW1haW5pbmcgdGV4dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRva2Vucy5hcHBlbmQodGV4dFtyZXMuZW5kIDpdKQoKICAgICMgZ2V0IHRoZSB0b2tlbnMgdGhhdCBvbmx5IGNvbnRhaW5zIHRoZSBlbnRpdGllcyB0aGF0IGNhbiBmb3JtIGEgc2VudGVuY2UKICAgIHBhcnRfYW5ub250YXRlZF90b2tlbnMgPSBbXQogICAgaWYgbm90IGlzX2Z1bGw6CiAgICAgICAgbGFzdF9lbmRfc2VudGVuY2UgPSAwCiAgICAgICAgZm9yIGksIHRva2VuIGluIGVudW1lcmF0ZSh0b2tlbnMpOgogICAgICAgICAgICBpZiBhbnkoaXRlbSBpbiB0b2tlbiBmb3IgaXRlbSBpbiBbIi4iLCAiISIsICI/Il0pIGFuZCBhbnkoCiAgICAgICAgICAgICAgICB0eXBlKGl0ZW0pIGlzIHR1cGxlIGZvciBpdGVtIGluIHRva2Vuc1tsYXN0X2VuZF9zZW50ZW5jZTppXQogICAgICAgICAgICApOgogICAgICAgICAgICAgICAgcGFydF9hbm5vbnRhdGVkX3Rva2Vucy5hcHBlbmQodG9rZW5zW2xhc3RfZW5kX3NlbnRlbmNlOmldKQogICAgICAgICAgICAgICAgbGFzdF9lbmRfc2VudGVuY2UgPSBpCiAgICAgICAgcmV0dXJuIHBhcnRfYW5ub250YXRlZF90b2tlbnMKICAgIHJldHVybiB0b2tlbnMKCgpkZWYgX2Fubm90YXRlKAogICAgdGV4dDogc3RyLCBzdF9hbmFseXplX3Jlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sIGlzX2Z1bGxfaHRtbDogYm9vbCA9IFRydWUKKSAtPiBMaXN0W3N0cl06CiAgICAiIiIKICAgIEFubm90YXRlIGlkZW50aWZpZWQgaW5wdXQgdXNpbmcgUHJlc2lkaW8gQW5vbnltaXplci4KCiAgICA6cGFyYW0gdGV4dDogICAgICAgICAgICAgICBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gc3RfYW5hbHl6ZV9yZXN1bHRzOiBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gYW5hbHlzaXMuCiAgICA6cGFyYW0gaXNfZnVsbF9odG1sOiAgICAgICBXaGV0aGVyIGdlbmVyYXRlIGZ1bGwgaHRtbCBvciBub3QuCgogICAgOnJldHVybnM6IFRoZSBsaXN0IG9mIHRva2VucyB3aXRoIHRoZSBpZGVudGlmaWVkIGVudGl0aWVzLgoKICAgICIiIgogICAgcmV0dXJuIF9nZXRfdG9rZW5zKHRleHQsIHN0X2FuYWx5emVfcmVzdWx0cywgaXNfZnVsbF9odG1sKQoKCmRlZiBfcHJvY2VzcygKICAgIHRleHQ6IHN0ciwKICAgIG1vZGVsOiBwYS5BbmFseXplckVuZ2luZSwKICAgIHNjb3JlX3RocmVzaG9sZDogZmxvYXQsCiAgICBlbnRpdGllczogTGlzdFtzdHJdID0gTm9uZSwKICAgIGVudGl0aWVzX29wZXJhdG9yX21hcDogZGljdCA9IE5vbmUsCiAgICBpc19mdWxsX3RleHQ6IGJvb2wgPSBUcnVlLAopIC0+IFR1cGxlW3N0ciwgc3RyLCBzdHJdOgogICAgIiIiCiAgICBQcm9jZXNzIHRoZSB0ZXh0IG9mIHN0ciB1c2luZyB0aGUgbW9kZWwuCgogICAgOnBhcmFtIHR4dDogICAgICAgICAgICAgICAgICAgVGV4dCB0byBwcm9jZXNzCiAgICA6cGFyYW0gbW9kZWw6ICAgICAgICAgICAgICAgICBNb2RlbCB0byB1c2UgZm9yIHByb2Nlc3NpbmcKICAgIDpwYXJhbSBlbnRpdGllczogICAgICAgICAgICAgIEVudGl0aWVzIHRvIHJlY29nbml6ZQogICAgOnBhcmFtIGVudGl0aWVzX29wZXJhdG9yX21hcDogVGhlIGVudGl0eV9vcGVyYXRvcl9tYXAgaXMgYSBkaWN0aW9uYXJ5IHRoYXQgbWFwcyBlbnRpdHkgdG8gb3BlcmF0b3IgbmFtZSBhbmQgb3BlcmF0b3IgcGFyYW1zLgogICAgOnBhcmFtIHNjb3JlX3RocmVzaG9sZDogICAgICAgVGhlIHNjb3JlIHRocmVzaG9sZCB0byB1c2UgZm9yIHJlY29nbml0aW9uCiAgICA6cGFyYW0gaXNfZnVsbF90ZXh0OiAgICAgICAgICBXaGV0aGVyIHRvIHJldHVybiB0aGUgZnVsbCB0ZXh0IG9yIGp1c3QgdGhlIGFubm90YXRlZCB0ZXh0CgogICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CgogICAgICAgICAgICAgICogdGhlIGFub255bWl6ZWQgdGV4dAogICAgICAgICAgICAgICogdGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIGFuYWx5c2lzCiAgICAiIiIKCiAgICAjIGdldCB0aGUgYW5hbHl6ZXIgZW5naW5lCgogICAgYW5hbHl6ZXIgPSBtb2RlbAoKICAgICMgYW5hbHl6ZSB0aGUgdGV4dCB0aGF0IGNhbiBiZSB1c2VkIGZvciBhbm9ueW1pemF0aW9uCiAgICByZXN1bHRzID0gYW5hbHl6ZXIuYW5hbHl6ZSgKICAgICAgICB0ZXh0PXRleHQsCiAgICAgICAgbGFuZ3VhZ2U9ImVuIiwKICAgICAgICBlbnRpdGllcz1lbnRpdGllcywKICAgICAgICBzY29yZV90aHJlc2hvbGQ9c2NvcmVfdGhyZXNob2xkLAogICAgICAgIHJldHVybl9kZWNpc2lvbl9wcm9jZXNzPVRydWUsCiAgICApCgogICAgIyBhbm9ueW1pemUgdGhlIHRleHQsIHJlcGxhY2UgdGhlIHBpaSBlbnRpdGllcyB3aXRoIHRoZSBsYWJlbHMKICAgIGFub255bWl6ZWRfdGV4dCA9IF9hbm9ueW1pemUodGV4dCwgcmVzdWx0cywgZW50aXRpZXNfb3BlcmF0b3JfbWFwLCBpc19mdWxsX3RleHQpCgogICAgcmV0dXJuIGFub255bWl6ZWRfdGV4dCwgcmVzdWx0cwoKCmRlZiBfZ2V0X3NpbmdsZV9odG1sKAogICAgdGV4dDogc3RyLCByZXN1bHRzOiBMaXN0W3BhLlJlY29nbml6ZXJSZXN1bHRdLCBpc19mdWxsX2h0bWw6IGJvb2wgPSBUcnVlCik6CiAgICAiIiIKICAgIEdlbmVyYXRlIHRoZSBodG1sIGZvciBhIHNpbmdsZSB0eHQgZmlsZS4KCiAgICA6cGFyYW0gdGV4dDogICAgICAgICBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gcmVzdWx0czogICAgICBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gYW5hbHlzaXMuCiAgICA6cGFyYW0gaXNfZnVsbF9odG1sOiBXaGV0aGVyIGdlbmVyYXRlIGZ1bGwgaHRtbCBvciBub3QuCgogICAgOnJldHVybnM6IFRoZSBodG1sIHN0cmluZyBmb3IgYSBzaW5nbGUgdHh0IGZpbGUuCiAgICAiIiIKICAgICMgY29udmVydCB0aGUgcmVzdWx0cyB0byB0b2tlbnMgdG8gZ2VuZXJhdGUgdGhlIGh0bWwKICAgIHRva2VucyA9IF9hbm5vdGF0ZSh0ZXh0LCByZXN1bHRzLCBpc19mdWxsX2h0bWwpCiAgICBodG1sID0gYXRfdXRpbC5nZXRfYW5ub3RhdGVkX2h0bWwoKnRva2VucykKCiAgICAjIGF2b2lkIHRoZSBlcnJvciBkdXJpbmcgcmVuZGVyaW5nIG9mIHRoZSBcbiBpbiB0aGUgaHRtbAogICAgYmFja3NsYXNoX2NoYXIgPSAiXFwiCgogICAgaHRtbF9zdHIgPSBmIjxwPntodG1sLnJlcGxhY2UoJ3tiYWNrc2xhc2hfY2hhcn1uJywgJzxicj4nKX08L3A+IgoKICAgIHJldHVybiBodG1sX3N0cgoKCmRlZiBfZ2V0X3NpbmdsZV9qc29uKHJlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sIGlzX2Z1bGxfcmVwb3J0OiBib29sID0gVHJ1ZSk6CiAgICAiIiIKICAgIEdlbmVyYXRlIHRoZSBqc29uIGZvciBhIHNpbmdsZSB0eHQgZmlsZS4KCiAgICA6cGFyYW0gcmVzdWx0czogICAgICAgIFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSBhbmFseXNpcy4KICAgIDpwYXJhbSBpc19mdWxsX3JlcG9ydDogV2hldGhlciBnZW5lcmF0ZSBmdWxsIGpzb24gb3Igbm90LgoKICAgIDpyZXR1cm5zOiBUaGUganNvbiBzdHJpbmcgZm9yIGEgc2luZ2xlIHR4dCBmaWxlLgogICAgIiIiCiAgICAjIGdlbmVyYXRlIHRoZSBzdGF0cyByZXBvcnQgaWYgbmVlZGVkCiAgICBpZiBub3QgaXNfZnVsbF9yZXBvcnQ6CiAgICAgICAgc3RhdHMgPSBbXQogICAgICAgICMgYWRkIHRoZSBzaW1wbGlmeSBzdGF0cyBsb2dpYyBoZXJlCiAgICAgICAgZm9yIGl0ZW0gaW4gcmVzdWx0czoKICAgICAgICAgICAgaXRlbS5hbmFseXNpc19leHBsYW5hdGlvbiA9IE5vbmUKICAgICAgICAgICAgc3RhdHMuYXBwZW5kKGl0ZW0pCiAgICBlbHNlOgogICAgICAgIHN0YXRzID0gcmVzdWx0cwoKICAgIHJldHVybiBzdGF0cwoKCmRlZiBfZ2V0X2FsbF9odG1sKAogICAgdHh0X2NvbnRlbnQ6IGRpY3QsCiAgICByZXNfZGljdDogZGljdCwKICAgIGlzX2Z1bGxfaHRtbDogYm9vbCA9IFRydWUsCik6CiAgICAiIiIKICAgIEdlbmVyYXRlIHRoZSBodG1sIGZvciBhbGwgdHh0IGZpbGVzLgoKICAgIDpwYXJhbSB0eHRfY29udGVudDogIFRoZSBkaWN0aW9uYXJ5IG9mIHR4dCBmaWxlIG5hbWUgYW5kIGNvbnRlbnQuCiAgICA6cGFyYW0gcmVzX2RpY3Q6ICAgICBUaGUgZGljdGlvbmFyeSBvZiB0eHQgZmlsZSBuYW1lIGFuZCB0aGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gYW5hbHlzaXMuCiAgICA6cGFyYW0gaXNfZnVsbF9odG1sOiBXaGV0aGVyIGdlbmVyYXRlIGZ1bGwgaHRtbCBvciBub3QuCgogICAgOnJldHVybnM6IFRoZSBodG1sIHN0cmluZyBmb3IgYWxsIHR4dCBmaWxlcy4KCiAgICAiIiIKICAgICMgVGhlc2UgYXJlIHBsYWNlaG9sZGVyIGZvciB0aGUgaHRtbCBzdHJpbmcKICAgIGh0bWxfaW5kZXggPSAiPGh0bWw+PGhlYWQ+PHRpdGxlPkhpZ2hsaWdodGVkIFBpaSBFbnRpdGllczwvdGl0bGU+PC9oZWFkPjxib2R5PjxoMT5IaWdobGlnaHRlZCBQaWkgRW50aXRpZXM8L2gxPjx1bD4iCiAgICBodG1sX2NvbnRlbnQgPSAiIgogICAgZm9yIHR4dF9maWxlLCByZXN1bHRzIGluIHJlc19kaWN0Lml0ZW1zKCk6CiAgICAgICAgdHh0ID0gdHh0X2NvbnRlbnRbdHh0X2ZpbGVdCiAgICAgICAgaHRtbF9pbmRleCArPSBmIjxsaT48YSBocmVmPScje3R4dF9maWxlfSc+e3R4dF9maWxlfTwvYT48L2xpPiIKICAgICAgICBodG1sX2NvbnRlbnQgKz0gZiI8bGk+PGgyPnt0eHRfZmlsZX08L2gyPjxwPntfZ2V0X3NpbmdsZV9odG1sKHR4dCwgcmVzdWx0cywgaXNfZnVsbF9odG1sKX08L3A+PC9saT4iCiAgICBodG1sX2luZGV4ICs9ICI8L3VsPiIKICAgIGh0bWxfcmVzID0gZiJ7aHRtbF9pbmRleH17aHRtbF9jb250ZW50fTwvYm9keT48L2h0bWw+IgoKICAgIHJldHVybiBodG1sX3JlcwoKCmRlZiBfZ2V0X2FsbF9ycHQocmVzX2RpY3Q6IGRpY3QsIGlzX2Z1bGxfcmVwb3J0OiBib29sID0gVHJ1ZSk6CiAgICAiIiIKICAgIEdlbmVyYXRlIHRoZSBzdGF0cyByZXBvcnQgZm9yIGFsbCB0eHQgZmlsZXMuCgogICAgOnBhcmFtIHJlc19kaWN0OiAgICAgICBUaGUgZGljdGlvbmFyeSBvZiB0eHQgZmlsZSBuYW1lIGFuZCB0aGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gYW5hbHlzaXMuCiAgICA6cGFyYW0gaXNfZnVsbF9yZXBvcnQ6IFdoZXRoZXIgZ2VuZXJhdGUgZnVsbCByZXBvcnQgb3Igbm90LgoKICAgIDpyZXR1cm5zOiBUaGUgc3RhdHMgcmVwb3J0IGZvciBhbGwgdHh0IGZpbGVzLgogICAgIiIiCiAgICAjIFRoZXNlIGFyZSBwbGFjZWhvbGRlciBmb3IgdGhlIGpzb24gcmVwb3J0CiAgICBzdGF0c19kaWN0ID0ge30KICAgIGZvciB0eHRfZmlsZSwgcmVzdWx0cyBpbiByZXNfZGljdC5pdGVtcygpOgogICAgICAgIG5ld19zdGF0cyA9IFtdCiAgICAgICAgZm9yIGl0ZW0gaW4gX2dldF9zaW5nbGVfanNvbihyZXN1bHRzLCBpc19mdWxsX3JlcG9ydCk6CiAgICAgICAgICAgIGlmIGlzX2Z1bGxfcmVwb3J0OgogICAgICAgICAgICAgICAgaXRlbS5hbmFseXNpc19leHBsYW5hdGlvbiA9IGl0ZW0uYW5hbHlzaXNfZXhwbGFuYXRpb24udG9fZGljdCgpCiAgICAgICAgICAgICAgICBuZXdfc3RhdHMuYXBwZW5kKGl0ZW0udG9fZGljdCgpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdG1wX2RpY3QgPSBpdGVtLnRvX2RpY3QoKQogICAgICAgICAgICAgICAgdG1wX2RpY3QucG9wKCJhbmFseXNpc19leHBsYW5hdGlvbiIpCiAgICAgICAgICAgICAgICB0bXBfZGljdC5wb3AoInJlY29nbml0aW9uX21ldGFkYXRhIikKICAgICAgICAgICAgICAgIG5ld19zdGF0cy5hcHBlbmQodG1wX2RpY3QpCiAgICAgICAgc3RhdHNfZGljdFt0eHRfZmlsZV0gPSBuZXdfc3RhdHMKICAgIHJldHVybiBzdGF0c19kaWN0CgoKZGVmIHJlY29nbml6ZV9waWkoCiAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCwKICAgIGlucHV0X3BhdGg6IFVuaW9uW3N0ciwgcGF0aGxpYi5QYXRoXSwKICAgIG91dHB1dF9wYXRoOiBzdHIsCiAgICBvdXRwdXRfc3VmZml4OiBzdHIsCiAgICBodG1sX2tleTogc3RyLAogICAgc2NvcmVfdGhyZXNob2xkOiBmbG9hdCwKICAgIGVudGl0aWVzOiBMaXN0WwogICAgICAgIHN0cgogICAgXSA9IE5vbmUsICAjIExpc3Qgb2YgZW50aXRpZXMgdG8gcmVjb2duaXplLCBkZWZhdWx0IGlzIHJlY29nbml6aW5nIGFsbAogICAgZW50aXR5X29wZXJhdG9yX21hcDogZGljdCA9IE5vbmUsCiAgICBtb2RlbDogc3RyID0gTm9uZSwKICAgIGdlbmVyYXRlX2pzb246IGJvb2wgPSBUcnVlLAogICAgZ2VuZXJhdGVfaHRtbDogYm9vbCA9IFRydWUsCiAgICBpc19mdWxsX3RleHQ6IGJvb2wgPSBUcnVlLAogICAgaXNfZnVsbF9odG1sOiBib29sID0gVHJ1ZSwKICAgIGlzX2Z1bGxfcmVwb3J0OiBib29sID0gVHJ1ZSwKKSAtPiBUdXBsZVtwYXRobGliLlBhdGgsIGRpY3QsIGRpY3RdOgogICAgIiIiCiAgICBXYWxrIHRocm91Z2ggdGhlIGlucHV0IHBhdGgsIHJlY29nbml6ZSBQSUkgaW4gdGV4dCBhbmQgc3RvcmUgdGhlIGFub255bWl6ZWQgdGV4dCBpbiB0aGUgb3V0cHV0IHBhdGguIEdlbmVyYXRlIHRoZSBodG1sIHdpdGggZGlmZmVyZW50IGNvbG9ycyBmb3IgZWFjaCBlbnRpdHksIGpzb24gcmVwb3J0IG9mIHRoZSBleHBsYWluYXRpb24uCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICAgICBUaGUgTUxSdW4gY29udGV4dC4gdGhpcyBpcyBuZWVkZWQgZm9yIGxvZyB0aGUgYXJ0aWZhY3RzLgogICAgOnBhcmFtIGlucHV0X3BhdGg6ICAgICAgICAgICBUaGUgaW5wdXQgcGF0aCBvZiB0aGUgdGV4dCBmaWxlcyBuZWVkcyB0byBiZSBhbmFseXppZWQuCiAgICA6cGFyYW0gb3V0cHV0X3BhdGg6ICAgICAgICAgIFRoZSBvdXRwdXQgcGF0aCB0byBzdG9yZSB0aGUgYW5vbnltaXplZCB0ZXh0LgogICAgOnBhcmFtIG91dHB1dF9zdWZmaXg6ICAgICAgICBUaGUgc3VyZml4IG9mIG91dHB1dCBrZXkgZm9yIHRoZSBhbm9ueW1pemVkIHRleHQuIGZvciBleGFtcGxlIGlmIHRoZSBpbnB1dCBmaWxlIGlzIHBpaS50eHQsIHRoZSBvdXRwdXQga2V5IGlzIGFub3ltaXplZCwgdGhlIG91dHB1dCBmaWxlIG5hbWUgd2lsbCBiZSBwaWlfYW5vbnltaXplZC50eHQuCiAgICA6cGFyYW0gaHRtbF9rZXk6ICAgICAgICAgICAgIFRoZSBodG1sIGtleSBmb3IgdGhlIGFydGlmYWN0LgogICAgOnBhcmFtIHNjb3JlX3RocmVzaG9sZDogICAgICBUaGUgc2NvcmUgdGhyZXNob2xkIHRvIG1hcmsgdGhlIHJlY29nbml0aW9uIGFzIHRydXN0ZWQuCiAgICA6cGFyYW0gZW50aXRpZXM6ICAgICAgICAgICAgIFRoZSBsaXN0IG9mIGVudGl0aWVzIHRvIHJlY29nbml6ZS4KICAgIDpwYXJhbSBlbnRpdHlfb3BlcmF0b3JfbWFwOiAgVGhlIG1hcCBvZiBlbnRpdHkgdG8gb3BlcmF0b3IgKG1hc2ssIHJlZGFjdCwgcmVwbGFjZSwga2VlcCwgaGFzaCwgYW5kIGl0cyBwYXJhbXMpCiAgICA6cGFyYW0gbW9kZWw6ICAgICAgICAgICAgICAgIFRoZSBtb2RlbCB0byB1c2UuIENhbiBiZSAic3BhY3kiLCAiZmxhaXIiLCAicGF0dGVybiIgb3IgIndob2xlIi4KICAgIDpwYXJhbSBnZW5lcmF0ZV9qc29uOiAgICAgICAgV2hldGhlciB0byBnZW5lcmF0ZSB0aGUganNvbiByZXBvcnQgb2YgdGhlIGV4cGxhaW5hdGlvbi4KICAgIDpwYXJhbSBnZW5lcmF0ZV9odG1sOiAgICAgICAgV2hldGhlciB0byBnZW5lcmF0ZSB0aGUgaHRtbCByZXBvcnQgb2YgdGhlIGV4cGxhaW5hdGlvbi4KICAgIDpwYXJhbSBpc19mdWxsX3RleHQ6ICAgICAgICAgV2hldGhlciB0byByZXR1cm4gdGhlIGZ1bGwgdGV4dCBvciBvbmx5IHRoZSBtYXNrZWQgdGV4dC4KICAgIDpwYXJhbSBpc19mdWxsX2h0bWw6ICAgICAgICAgV2hldGhlciB0byByZXR1cm4gdGhlIGZ1bGwgaHRtbCBvciBqdXN0IHRoZSBhbm5vdGF0ZWQgdGV4dAogICAgOnBhcmFtIGlzX2Z1bGxfcmVwb3J0OiAgICAgICBXaGV0aGVyIHRvIHJldHVybiB0aGUgZnVsbCByZXBvcnQgb3IganVzdCB0aGUgc2NvcmUgYW5kIHN0YXJ0LCBlbmQgaW5kZXgKCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKCiAgICAgICAgICAgICAgKiBQYXRoIHRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5CiAgICAgICAgICAgICAgKiBUaGUganNvbiByZXBvcnQgb2YgdGhlIGV4cGxhaW5hdGlvbiAoaWYgZ2VuZXJhdGVfanNvbiBpcyBUcnVlKQogICAgICAgICAgICAgICogQSBkaWN0aW9uYXJ5IG9mIGVycm9ycyBmaWxlcyB0aGF0IHdlcmUgbm90IHByb2Nlc3NlZAoKICAgICIiIgoKICAgICMgU2V0IG91dHB1dCBkaXJlY3RvcnkKICAgIGlmIG91dHB1dF9wYXRoIGlzIE5vbmU6CiAgICAgICAgb3V0cHV0X3BhdGggPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKCiAgICAjIENyZWF0ZSB0aGUgb3V0cHV0IGRpcmVjdG9yeToKICAgIG91dHB1dF9kaXJlY3RvcnkgPSBwYXRobGliLlBhdGgob3V0cHV0X3BhdGgpCiAgICBpZiBub3Qgb3V0cHV0X2RpcmVjdG9yeS5leGlzdHMoKToKICAgICAgICBvdXRwdXRfZGlyZWN0b3J5Lm1rZGlyKCkKCiAgICB0eHRfZmlsZXNfZGlyZWN0b3J5ID0gcGF0aGxpYi5QYXRoKGlucHV0X3BhdGgpCiAgICBlcnJvcnMgPSB7fQoKICAgIHJlc19kaWN0ID0ge30KICAgIHR4dF9jb250ZW50ID0ge30KICAgICMgTG9hZCB0aGUgbW9kZWw6CiAgICB0cnk6CiAgICAgICAgYW5hbHl6ZXIgPSBfZ2V0X2FuYWx5emVyX2VuZ2luZShtb2RlbCwgZW50aXRpZXMpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZXJyb3JzWyJtb2RlbCJdID0gc3RyKGUpCiAgICAgICAgbG9nZ2VyLmVycm9yKGYiRXJyb3Igd2hlbiBnZXQgdGhlIG1vZGVsOiB7ZX0iKQoKICAgIGxvZ2dlci5pbmZvKCJNb2RlbCBsb2FkZWQiKQogICAgIyBHbyBvdmVyIHRoZSB0ZXh0IGZpbGVzIGluIHRoZSBpbnB1dCBwYXRoLCBhbmFseXplIGFuZCBhbm9ueW1pemUgdGhlbToKICAgIGZvciBpLCB0eHRfZmlsZSBpbiBlbnVtZXJhdGUoCiAgICAgICAgdHFkbSgKICAgICAgICAgICAgbGlzdCh0eHRfZmlsZXNfZGlyZWN0b3J5Lmdsb2IoIioudHh0IikpLAogICAgICAgICAgICBkZXNjPSJQcm9jZXNzaW5nIGZpbGVzIiwKICAgICAgICAgICAgdW5pdD0iZmlsZSIsCiAgICAgICAgKQogICAgKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTG9hZCB0aGUgc3RyIGZyb20gdGhlIHRleHQgZmlsZQogICAgICAgICAgICB0ZXh0ID0gdHh0X2ZpbGUucmVhZF90ZXh0KCkKICAgICAgICAgICAgdHh0X2NvbnRlbnRbc3RyKHR4dF9maWxlKV0gPSB0ZXh0CiAgICAgICAgICAgICMgUHJvY2VzcyB0aGUgdGV4dCB0byByZWNvZ2luemUgdGhlIHBpaSBlbnRpdGllcyBpbiBpdAogICAgICAgICAgICBhbm9ueW1pemVkX3RleHQsIHJlc3VsdHMgPSBfcHJvY2VzcygKICAgICAgICAgICAgICAgIHRleHQ9dGV4dCwKICAgICAgICAgICAgICAgIG1vZGVsPWFuYWx5emVyLAogICAgICAgICAgICAgICAgZW50aXRpZXM9ZW50aXRpZXMsCiAgICAgICAgICAgICAgICBlbnRpdGllc19vcGVyYXRvcl9tYXA9ZW50aXR5X29wZXJhdG9yX21hcCwKICAgICAgICAgICAgICAgIHNjb3JlX3RocmVzaG9sZD1zY29yZV90aHJlc2hvbGQsCiAgICAgICAgICAgICAgICBpc19mdWxsX3RleHQ9aXNfZnVsbF90ZXh0LAogICAgICAgICAgICApCiAgICAgICAgICAgIHJlc19kaWN0W3N0cih0eHRfZmlsZSldID0gcmVzdWx0cwogICAgICAgICAgICAjIFN0b3JlIHRoZSBhbm9ueW1pemVkIHRleHQgaW4gdGhlIG91dHB1dCBwYXRoCiAgICAgICAgICAgIG91dHB1dF9maWxlID0gKAogICAgICAgICAgICAgICAgb3V0cHV0X2RpcmVjdG9yeQogICAgICAgICAgICAgICAgLyBmIntzdHIodHh0X2ZpbGUucmVsYXRpdmVfdG8odHh0X2ZpbGVzX2RpcmVjdG9yeSkpLnNwbGl0KCcuJylbMF19X3tvdXRwdXRfc3VmZml4fS50eHQiCiAgICAgICAgICAgICkKICAgICAgICAgICAgb3V0cHV0X2ZpbGUucGFyZW50Lm1rZGlyKHBhcmVudHM9VHJ1ZSwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAgICAgd2l0aCBvcGVuKG91dHB1dF9maWxlLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGFub255bWl6ZWRfdGV4dCkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcnNbc3RyKHR4dF9maWxlKV0gPSBzdHIoZSkKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiRXJyb3IgcHJvY2Vzc2luZyB7dHh0X2ZpbGV9OiB7ZX0iKQogICAgaWYgZ2VuZXJhdGVfaHRtbDoKICAgICAgICAjIEdlbmVyYXRlIHRoZSBodG1sIHJlcG9ydAogICAgICAgIGh0bWxfcmVzID0gX2dldF9hbGxfaHRtbCh0eHRfY29udGVudCwgcmVzX2RpY3QsIGlzX2Z1bGxfaHRtbCkKICAgICAgICAjIFN0b3JlIHRoZSBodG1sIHJlcG9ydCBpbiB0aGUgY29udGV4dAogICAgICAgIGFydGlfaHRtbCA9IG1scnVuLmFydGlmYWN0cy5BcnRpZmFjdChib2R5PWh0bWxfcmVzLCBmb3JtYXQ9Imh0bWwiLCBrZXk9aHRtbF9rZXkpCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoYXJ0aV9odG1sKQogICAgaWYgZ2VuZXJhdGVfanNvbjoKICAgICAgICAjIEdlbmVyYXRlIHRoZSBqc29uIHJlcG9ydAogICAgICAgIGpzb25fcmVzID0gX2dldF9hbGxfcnB0KHJlc19kaWN0LCBpc19mdWxsX3JlcG9ydCkKICAgICAgICByZXR1cm4gb3V0cHV0X3BhdGgsIGpzb25fcmVzLCBlcnJvcnMKICAgIHJldHVybiBvdXRwdXRfcGF0aCwgZXJyb3JzCg==
    base_image: mlrun/mlrun
    commands:
    - python -m pip install nltk pandas presidio-anonymizer presidio-analyzer torch
      flair@git+https://github.com/flairNLP/flair.git@d4ed67bf663e4066517f00397412510d90043653
      st-annotated-text https://huggingface.co/beki/en_spacy_pii_distilbert/resolve/main/en_spacy_pii_distilbert-any-py3-none-any.whl
    code_origin: git@github.com-personal:pengwei715/functions.git#5468a7acb9b9fde12832e27daac2624f43746ee7:/Users/Peng_Wei/work/mlrun_related/functions/pii_recognizer/pii_recognizer.py
    origin_filename: /Users/Peng_Wei/work/mlrun_related/functions/pii_recognizer/pii_recognizer.py
    requirements: []
  entry_points:
    recognize_pii:
      name: recognize_pii
      doc: Walk through the input path, recognize PII in text and store the anonymized
        text in the output path. Generate the html with different colors for each
        entity, json report of the explaination.
      parameters:
      - name: context
        type: MLClientCtx
        doc: The MLRun context. this is needed for log the artifacts.
        default: ''
      - name: input_path
        type: str
        doc: The input path of the text files needs to be analyzied.
        default: ''
      - name: output_path
        type: str
        doc: The output path to store the anonymized text.
        default: ''
      - name: output_suffix
        type: str
        doc: The surfix of output key for the anonymized text. for example if the
          input file is pii.txt, the output key is anoymized, the output file name
          will be pii_anonymized.txt.
        default: ''
      - name: html_key
        type: str
        doc: The html key for the artifact.
        default: ''
      - name: score_threshold
        type: float
        doc: The score threshold to mark the recognition as trusted.
        default: ''
      - name: entities
        type: List[str]
        doc: The list of entities to recognize.
        default: null
      - name: entity_operator_map
        type: dict
        doc: The map of entity to operator (mask, redact, replace, keep, hash, and
          its params)
        default: null
      - name: model
        type: str
        doc: The model to use. Can be "spacy", "flair", "pattern" or "whole".
        default: null
      - name: generate_json
        type: bool
        doc: Whether to generate the json report of the explaination.
        default: true
      - name: generate_html
        type: bool
        doc: Whether to generate the html report of the explaination.
        default: true
      - name: is_full_text
        type: bool
        doc: Whether to return the full text or only the masked text.
        default: true
      - name: is_full_html
        type: bool
        doc: Whether to return the full html or just the annotated text
        default: true
      - name: is_full_report
        type: bool
        doc: Whether to return the full report or just the score and start, end index
        default: true
      outputs:
      - default: ''
        doc: 'A tuple of:'
      lineno: 850
  description: This function is used to recognize PII in a directory of text files
  default_handler: recognize_pii
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  resources:
    requests:
      memory: 1Mi
      cpu: 25m
    limits:
      memory: 20Gi
      cpu: '2'
  priority_class_name: ''
  preemption_mode: prevent
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: app.iguazio.com/lifecycle
            operator: NotIn
            values:
            - preemptible
          - key: eks.amazonaws.com/capacityType
            operator: NotIn
            values:
            - SPOT
          - key: node-lifecycle
            operator: NotIn
            values:
            - spot
  tolerations: null
  security_context: {}
verbose: false